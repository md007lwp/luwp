<!DOCTYPE html>
<html lang="en">


<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>聊天机器人-聊天频道</title>
  <link rel="shortcut icon" href="./asset/favicon.ico" type="image/x-icon" />
  <link rel="stylesheet" href="./css/common.css" />
  <link rel="stylesheet" href="./css/index.css" />
</head>

<!-- <body>
    <button>1</button><button>2</button><button>3</button><button>4</button><button>5</button><button>6</button><button>7</button><button>8</button><button>9</button><button>10</button>
    <div>
        <select name="" class="prov">

        </select>
    </div>
</body>


<script>
    // let btns = document.querySelectorAll('button');
    // for (let index = 0; index < btns.length; index++) {
    //     btns[index].addEventListener('click', () => {
    //         console.log(index + 1);
    //     })
    // }

    // for (var index = 0; index < btns.length; index++) {
    //     (function (index) {
    //         btns[index].addEventListener('click', () => {
    //             console.log(index + 1);
    //         })
    //     })(index)

    // }


    // let arr = [], n = 10, m = 100;
    // for (let i = 0; i < 10; i++) {
    //     // arr[i] = parseFloat(Math.random().toFixed(3));
    //     arr[i] = Math.floor(Math.random() * (m - n)) + n;
    // }

    // let arr = Array(10).fill(0);
    // for (const itme of arr) {
    //     itme = parseFloat(Math.random().toFixed(3));
    // }
    // arr.forEach((item, index, arr) => {
    // arr.fill(parseFloat(Math.random().toFixed(3), index));
    // arr[index] = parseFloat(Math.random().toFixed(3));
    // })
    // console.log(arr);

    // let str = "1.gif";
    // let result = ['.jpg', '.gif', '.png', '.bmp'].some(item => str.endsWith(item));

    // console.log(['.jpg', '.gif', '.png', '.bmp'].includes(str.substring(str.lastIndexOf('.'))));

    // console.log(result);

    // let stus = [{
    //     id: 101,
    //     name: "张三",
    //     sex: "男",
    //     age: 19,
    //     tel: 13111111111,
    //     address: "武汉市花山郡二期5栋103室"
    // }, {
    //     id: 102,
    //     name: "王迪",
    //     sex: "女",
    //     age: 25,
    //     tel: 13122222222,
    //     address: "北京市西直门136号"
    // }, {
    //     id: 103,
    //     name: "魏王度",
    //     sex: "男",
    //     age: 18,
    //     tel: 13122223333,
    //     address: "武汉市水果湖芒果街111号"
    // }, {
    //     id: 104,
    //     name: "杰克",
    //     sex: "男",
    //     age: 29,
    //     tel: 13155554444,
    //     address: "内蒙古锡林郭勒二旗303号"
    // }, {
    //     id: 105,
    //     name: "丽萨",
    //     sex: "女",
    //     age: 22,
    //     tel: 13155556661,
    //     address: "北京市前门大街歪脖子胡同2号"
    // }]
    // stus.forEach(item => console.log(item.name));
    // console.log(stus.filter(item => item.sex === "女"));
    // console.log(stus.filter(item => {
    //     return item.sex === "女" && item.age < 25;
    // }))

    // console.log(stus.filter(item=>item.name.substr(0,1)==="王"));
    // console.log(stus.filter(item => item.tel.toString().substr(-1) === '1'));
    // console.log(stus.filter(item => item.tel.toString().endsWith('1')));

    // console.log(stus.map(item => item.name));

    // console.log(stus.map(item => item.name).join(','));
    // console.log(stus.reduce((str, cur) => {
    //     return str += ',' + cur.name;
    // }, "").substring(1))
    // console.log(stus.map(item => `<p>${item.name}</p>`).join(''))

    // console.log(stus.reduce(function (total, item) {
    //     return total += `<p>${item.name}</p>`;
    // }, ''))

    // console.log(stus.filter(item => item.sex === '女').map(item=>item.name))
    // let result = "";
    // result = stus.filter(item => item.sex === "女");
    // result = stus.filter(item => item.sex === "女").map(item => {
    //     return { name: item.name, tel: item.tel };
    // })
    // console.log(result);
    // result = stus.reduce((total, item) => {
    //     return total += item.age;
    // }, 0) / stus.length;
    // result = stus.find(item => item.id === "103");

    // result = stus.some(item => item.age > 28);

    // let user = { name: "zs", phone: 12311111111 };
    // console.log(Object.keys(user));
    // console.log(Object.values(user));
    // console.log(Object.entries(user));

    // for (const [key, val] of Object.entries(user)) {
    //     console.log(`${key}:${val}`)
    // }

    // function createUser(firstName, lastName) {
    //     return {
    //         firstName, lastName, fullName: `${firstName}${lastName}`,
    //         sayHell() {
    //             console.log(`我叫:${this.fullName}`);
    //         }
    //     }
    //         ;

    // }
    // let { fullName, lastName } = createUser("中", "国");
    // console.log(`我叫:${fullName}`)
    // console.log(`${lastName}`)

    // let obj = { a: 1, b: 2, c: 3 }
    // Object.keys(obj).forEach(item => console.log(item))
    // console.log(...Object.keys(obj));
    // console.log(...Object.values(obj));
    // console.log(...Object.entries(obj));
    // let newObj = Object.fromEntries(Object.entries(obj));
    // console.log(Object.is(obj, newObj));
    // let newObj = {};
    // for (const [key, val] of Object.entries(obj)) {
    //     newObj[key] = val;
    // }
    // console.log(newObj);
    // console.log(Object.is(obj,newObj));
    // let objArr = Object.entries(obj);
    // objArr.shift()
    // console.log(Object.fromEntries(objArr))
    // let newObj = {
    //     ...obj
    // }
    // let { a, ...newObj } = obj;
    // console.log(newObj);
    // console.log(Object.is(obj, newObj));

    // function createOptions(option) {
    //     option = option || {};
    //     defalutOption = { time: 1000, speed: 50, text: "hello word" }
    //     return {
    //         ...defalutOption,
    //         ...option
    //     }
    // }
    // console.log(createOptions());
    // console.log(createOptions({ time: 100 }));
    // let user = { name: '钻石', age: 12, phone: 13111111111 }
    // console.log(Object.getOwnPropertyDescriptors(user))
    // for (const key of user) {
    // Object.defineProperty(user, key, {
    //     get() {
    //         console.log(`正在读取key属性，值为${val}`);
    //         return user[key];
    //     }, set(val) {
    //         console.log(`正在设置key属性，新的值为${val}`);
    //         user[key] = val;
    //     }
    // })
    // }


    // for (let [key, value] of Object.entries(user)) {
    //     Object.defineProperty(user, key, {
    //         get() {
    //             console.log(`正在读取${key}属性，值为${value}`);
    //             return value;
    //         }, set(val) {
    //             console.log(`正在设置${key}属性，新的值为${value}`);
    //             value = val;
    //         }
    //     })
    //     console.log(key, value);
    // }
    // class Animal {
    //     constructor(name, ...hobby) {
    //         this.name = name
    //         this.hobby = hobby;
    //     }
    //     seyHello() {
    //         console.log(this.name, this.hobby, this.age);
    //     }
    // }

    // class Dog extends Animal {
    //     constructor(name, age, ...hobby) {
    //         super(name, ...hobby);
    //         this.age = age;
    //     }
    // }

    // let wc = new Dog('旺财', 3, '睡觉', '抓老鼠');
    // wc.hobby.push('守门');
    // let xq = new Dog('小强', 10, '吃饭');
    // // console.log(wc);
    // console.log(wc.seyHello());
    // console.log(xq.seyHello());

    // const sum = (...nums) => {
    //     let result = nums.length || 0;
    //     if (result) {
    //         return nums.reduce((cur, val) => cur + val, 0);
    //     } else {
    //         return result;
    //     }
    // }
    // console.log(sum());
    // console.log(sum(1));
    // console.log(sum(1, 2));
    // console.log(sum(1, 2, 3));
    // const arr = [1, 2, 3, 4, 5, 6];
    // console.log(sum(...arr));

    // const counter = {
    //     count: 0,
    //     startIncrease() {
    //         setInterval(() => {
    //             // counter.count++;
    //             //箭头函数内没有this,当前this指的是其外层的this
    //             this.count++;
    //             console.log(counter.count);
    //         }, 1000)
    //     }
    // }

    //当传入参数为不确定属性组成配置对象时,可以采取解构对象来实现默认值
    // const getData = ({ page = 1, num = 10, keyWord = '' } = {}) => {
    //     console.log(`${page}-${num}-${keyWord ? keyWord : '空'}`);
    // }
    // getData();//当参数为空时，默认赋值为空对象，对空对象进行解构，再给其填充默认属性赋值
    // getData({ page: 1 });
    // getData({ page: 1, num: 10 });
    // getData({ page: 1, num: 10, keyWord: '电视' });

    //类语法练习
    // class User {
    //     constructor(name, pwd) {
    //         this.name = name;
    //         this.pwd = pwd;
    //     }
    //     sayHello() {
    //         console.log(`${this.name}-${this.pwd}`);
    //     }
    // }
    // let u1 = new User('zs', '123');
    // u1.sayHello();

    // 函数防抖
    //当用不希望某一行为被频繁触发，而是在其行为停顿或结束后触发
    // const debounce = (fn, thime = 1000) => {
    //     let tid;
    //     return (...args) => {
    //         clearTimeout(tid);
    //         tid = setTimeout(() => {
    //             fn(...args);
    //         }, 1000);
    //     }
    // }
    // let fn = (a = 1, b = 2) => { console.log(a + b) }
    // let dfn = debounce(fn);
    // let btns = document.querySelectorAll('button');
    // btns[0].onclick = function (e) {
    //     dfn();
    // };


    //一个延迟函数
    // function delay(duration) {
    //     return new Promise((resolve, rejcet) => {
    //         setTimeout(() => {
    //             if (Math.floor(Math.random() > 0.3)) {
    //                 resolve('执行成功！');
    //             } else {
    //                 rejcet('执行失败！');
    //             }
    //         }, duration);
    //     })
    // }
    // delay(1000).then((reply) => {
    //     console.log(reply);
    // }, (reply) => {
    //     console.log(reply);
    // });

    //练习Promise  加载一张图片（异步），当加载成功就将图片展示到页面上，失败则输出失败原因
    // function createImg(url) {
    //     return new Promise((resolve, rejcet) => {
    //         let img = document.createElement('img');
    //         img.src = url;
    //         img.onload = () => {
    //             resolve(img);
    //         }
    //         img.onerror = (err) => {
    //             rejcet(err)
    //         }
    //     })
    // }
    // let body = document.querySelector('body')
    // let imgUrl = "https://pics6.baidu.com/feed/9213b07eca8065387f2cbeef658a754baf3482eb.jpeg@f_auto?token=696ca87369cfbad3911cd17cd9d07856";
    // createImg(imgUrl).then(img => {
    //     body.append(img);
    // }, err => {
    //     console.log(err);
    // })
    //练习 远程加载省份数据，返回一个promise
    // function getProvinces() {
    //     return fetch('https://study.duyiedu.com/api/citylist')
    //         .then(resp => resp.json())
    //         .then(reps => reps.data)
    //         .then(resp => resp.map(item => ({ value: item.value, label: item.label }))
    //         );
    // }
    // 由于是promise,所以可以通过then来处理成功或失败后的处理
    // getProvinces().then(provArr => {
    //     let provSel = document.querySelector('.prov')
    //     provSel.innerHTML = provArr.reduce((optStr, item) => optStr + `<option value='${item.value}'>${item.label}</option>`, `<option value='-1'>请选择</option>`);
    // }, reason => {
    //     console.log(reason);
    // })

    
</script>
<script src="./test.js"></script> -->

  <div class="container">
    <div class="main">
      <h1 class="main-title">
        <img src="./asset/robot.png" alt="" />
        AI 聊天机器人
      </h1>
      <div class="chat-container">
        <div class="chat-item me">
          <img class="chat-avatar" src="./asset/avatar.png" />
          <div class="chat-content">你几岁啦？</div>
          <div class="chat-date">2022-04-29 14:18:13</div>
        </div>
        <div class="chat-item">
          <img class="chat-avatar" src="./asset/robot-avatar.jpg" />
          <div class="chat-content">讨厌，不要随便问女生年龄知道不</div>
          <div class="chat-date">2022-04-29 14:18:16</div>
        </div>
      </div>
      <form class="msg-container">
        <input type="text" id="txtMsg" placeholder="在这里输入要发送的消息，按回车键即可发送" />
        <button>发送</button>
      </form>
    </div>
    <div class="aside">
      <img src="./asset/avatar.png" class="aside-avatar" alt="" />
      <p id="nickname" class="aside-name"></p>
      <p id="loginId" class="aside-account"></p>
    </div>
    <div class="close">
      <i class="iconfont icon-close"></i>
    </div>
  </div>
  <script src="./js/ajax.js"></script>
  <script src="./js/api.js"></script>
  <script src="./js/user.js"></script>

  <script>

    (async () => {
      const userState = await API.profile();
      if (!userState.data) {
        alert('登录状态已过期，请重新登录！');
        location.href = './login.html'
      }
      const doms = {
        closeBtn: document.querySelector('.close'),
        nickname: document.getElementById('nickname'),
        loginId: document.getElementById('loginId'),
        charContainer: document.querySelector('.chat-container')
      }
      doms.loginId.innerText = userState.data.loginId;
      doms.nickname.innerText = userState.data.nickname;

      doms.closeBtn.onclick = () => {
        localStorage.removeItem('authorization');
        location.href = './login.html'
      }
      //获取当前用户全部聊天记录
      getMsgAll();

      // 获取全部聊天信息并加载
      async function getMsgAll() {
        const resp = await API.getHistory();
        // updataInfo(resp.data);
        for (const item of resp.data) {
          chatInfo(item);
        }
      }
      //发送信息 
      document.querySelector('button').onclick = async function (e) {
        e.preventDefault();
        const msg = document.getElementById('txtMsg').value.trim();
        if (!msg) return '';
        //输出发送内容
        // updataInfo([{
        //   content: msg,
        //   createdAt: Date.now(),
        //   from: "123"
        // }], 'add');
        chatInfo({
          content: msg,
          createdAt: Date.now(),
          from: "123"
        });
        document.getElementById('txtMsg').value = '';
        const resp = await API.sendChat(msg);
        // updataInfo([resp.data], 'add');
        // chatInfo();
        chatInfo({
          to: '123',
          from: null,
          ...resp.data
        });
      }
      const createElem = (elemStr) => {
        return document.createElement(elemStr);
      }
      const chatInfo = (chatInfo) => {
        const div = createElem('div');
        const img = createElem('img');
        const content = createElem('div');
        const date = createElem('div');
        div.className = 'chat-item';
        img.className = 'chat-avatar';
        img.src = chatInfo.from ? './asset/avatar.png' : './asset/robot-avatar.jpg';
        content.className = 'chat-content';
        content.innerText = chatInfo.content;
        date.className = 'chat-date';
        date.innerText = timestampToDateFormat(chatInfo.createdAt);
        if (chatInfo.from) {
          div.classList.add('me');
        }
        div.appendChild(img);
        div.appendChild(content);
        div.appendChild(date);
        doms.charContainer.appendChild(div);
        doms.charContainer.scrollTop = doms.charContainer.scrollHeight;
      }

      //更新聊天内容
      function updataInfo(data, type) {
        // array.filter((_, index) => index % 2 !== 0)
        const htmlStr = data.map((item, index) => {
          // if (index % 2 === 0) {
          if (item.from) {
            return ` <div class="chat-item me">
          <img class="chat-avatar" src="./asset/avatar.png" />
          <div class="chat-content">${item.content}</div>
          <div class="chat-date">${timestampToDateFormat(item.createdAt)}</div>
        </div>`
          } else {
            return ` <div class="chat-item">
          <img class="chat-avatar" src="./asset/robot-avatar.jpg" />
          <div class="chat-content">${item.content}</div>
          <div class="chat-date">${timestampToDateFormat(item.createdAt)}</div>
        </div>`
          }

        }).join('');
        if (type) {
          const range = document.createRange();
          // 使用createContextualFragment方法将HTML字符串转换为文档片段
          const fragment = range.createContextualFragment(htmlStr);
          // 将文档片段插入到DOM中
          doms.charContainer.appendChild(fragment);
        } else {
          doms.charContainer.innerHTML = htmlStr;
        }
        doms.charContainer.scrollTop = doms.charContainer.scrollHeight;
      }
      //时间戳转换成指定格式日期
      function timestampToDateFormat(timestamp) {
        const dateObj = new Date(timestamp); // 创建Date对象
        const year = dateObj.getFullYear(); // 获取年份
        const month = ("0" + (dateObj.getMonth() + 1)).slice(-2); // 获取月份，并补零
        const day = ("0" + dateObj.getDate()).slice(-2); // 获取日期，并补零

        const hours = dateObj.getHours().toString().padStart(2, '0');
        const minutes = dateObj.getMinutes().toString().padStart(2, '0');
        const seconds = dateObj.getSeconds().toString().padStart(2, '0');
        return `${year}-${month}-${day} ${hours}-${minutes}-${seconds}`; // 返回转换后的日期格式
      }


    })()

  </script>
</body>

</html>